#!/usr/bin/env python3
"""
Project CLI - Command Launcher for Agentive Projects
=====================================================

Simple memorable command interface for common project operations.

Usage:
    ./project linearsync     - Sync tasks to Linear
    ./project sync           - Alias for linearsync
    ./project help           - Show help
"""

import subprocess
import sys
from pathlib import Path


def main():
    """Launch project commands."""
    # Get the project directory
    project_dir = Path(__file__).parent

    # Use venv Python if available, otherwise system Python
    venv_python = project_dir / "venv" / "bin" / "python3"
    if not venv_python.exists():
        venv_python = project_dir / ".venv" / "bin" / "python3"
    python_cmd = str(venv_python) if venv_python.exists() else "python3"

    # Show help if no arguments
    if len(sys.argv) == 1:
        print_help()
        sys.exit(0)

    command = sys.argv[1].lower()

    # Handle commands
    if command in ["linearsync", "sync", "linear"]:
        # Linear sync command
        print("üöÄ Syncing tasks to Linear...")
        sync_args = sys.argv[2:] if len(sys.argv) > 2 else []
        cmd = [
            python_cmd,
            str(project_dir / "scripts" / "sync_tasks_to_linear.py"),
        ] + sync_args

    elif command in ["teams", "linearteams"]:
        # List Linear teams
        print("üè¢ Listing Linear teams...")
        cmd = [
            python_cmd,
            "-c",
            """
import os
import sys
from pathlib import Path
from dotenv import load_dotenv
from gql import gql, Client
from gql.transport.requests import RequestsHTTPTransport

# Load .env from project root
env_path = Path.cwd() / '.env'
if env_path.exists():
    load_dotenv(env_path)

api_key = os.getenv('LINEAR_API_KEY')
if not api_key:
    print('‚ùå LINEAR_API_KEY not found in .env')
    print('   Get your key at: https://linear.app/settings/api')
    sys.exit(1)

transport = RequestsHTTPTransport(
    url='https://api.linear.app/graphql',
    headers={'Authorization': api_key},
    use_json=True
)

try:
    client = Client(transport=transport, fetch_schema_from_transport=True)
    query = gql('''
        query {
          teams {
            nodes {
              id
              key
              name
            }
          }
        }
    ''')

    result = client.execute(query)
    teams = result['teams']['nodes']

    if not teams:
        print('‚ùå No teams found in Linear workspace')
        sys.exit(1)

    print()
    print('üè¢ Your Linear Teams:')
    print('=' * 70)
    for team in teams:
        print(f"Team: {team['name']}")
        print(f"  Key:  {team['key']}")
        print(f"  UUID: {team['id']}")
        print()

    print('üí° To use a specific team, add to .env:')
    print(f"   LINEAR_TEAM_ID={teams[0]['key']}  # (or any team KEY above)")

except Exception as e:
    print(f'‚ùå Error connecting to Linear: {e}')
    sys.exit(1)
""",
        ]

    elif command in ["help", "-h", "--help"]:
        print_help()
        sys.exit(0)

    elif command == "version":
        print("Project CLI v1.0.0")
        print("Part of Agentive Starter Kit")
        sys.exit(0)

    else:
        print(f"‚ùå Unknown command: {command}")
        print("Run './project help' for available commands.")
        sys.exit(1)

    # Run the command from project directory
    try:
        result = subprocess.run(cmd, cwd=project_dir)
        sys.exit(result.returncode)
    except subprocess.CalledProcessError as e:
        print(f"‚ùå Error running command: {e}")
        sys.exit(1)
    except KeyboardInterrupt:
        print("\n‚ö†Ô∏è  Operation cancelled by user")
        sys.exit(0)
    except FileNotFoundError:
        print(f"‚ùå Python not found at: {python_cmd}")
        print("   Make sure you have a virtual environment set up:")
        print("   python3 -m venv venv && source venv/bin/activate")
        sys.exit(1)


def print_help():
    """Print help message."""
    print(
        """
Project CLI - Agentive Starter Kit
==================================

Usage: ./project <command> [options]

Commands:
  linearsync, sync   Sync task files to Linear
  teams              List all Linear teams (KEY, UUID, name)
  help               Show this help message
  version            Show version information

Examples:
  ./project linearsync           Sync all tasks to Linear
  ./project teams                List available Linear teams
  ./project sync                 Alias for linearsync

Setup:
  1. Create a virtual environment:
     python3 -m venv venv && source venv/bin/activate

  2. Install dependencies:
     pip install -e ".[dev,linear]"

  3. Configure Linear API:
     cp .env.template .env
     # Edit .env and add your LINEAR_API_KEY

  4. List teams (if you have multiple):
     ./project teams

  5. Sync tasks:
     ./project linearsync

For more information, see README.md
"""
    )


if __name__ == "__main__":
    main()
