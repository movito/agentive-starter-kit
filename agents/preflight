#!/bin/bash
#
# Preflight Check for Agentive Starter Kit
# Validates that all required dependencies are installed before onboarding.
#
# Usage: ./agents/preflight
#

# Don't use set -e because arithmetic operations can return non-zero

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Counters
PASS=0
WARN=0
FAIL=0

# Print header
echo ""
echo -e "${BOLD}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BOLD}                  Agentive Starter Kit                         ${NC}"
echo -e "${BOLD}                    Preflight Check                            ${NC}"
echo -e "${BOLD}═══════════════════════════════════════════════════════════════${NC}"
echo ""

# Helper functions
check_pass() {
    echo -e "  ${GREEN}✓${NC} $1"
    ((PASS++))
}

check_warn() {
    echo -e "  ${YELLOW}⚠${NC} $1"
    ((WARN++))
}

check_fail() {
    echo -e "  ${RED}✗${NC} $1"
    ((FAIL++))
}

section() {
    echo ""
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}$(printf '─%.0s' {1..50})${NC}"
}

# ============================================================================
# MUST HAVE (Required)
# ============================================================================

section "Must Have (Required)"

# Check: Claude Code
if command -v claude &> /dev/null; then
    CLAUDE_VERSION=$(claude --version 2>/dev/null | head -n1 || echo "installed")
    check_pass "Claude Code: $CLAUDE_VERSION"
else
    check_fail "Claude Code: Not found"
    echo "         Install from: https://claude.ai/download"
    echo "         Or install the VS Code/Cursor extension"
fi

# Check: Git installed
if command -v git &> /dev/null; then
    GIT_VERSION=$(git --version | head -n1)
    check_pass "Git: $GIT_VERSION"
else
    check_fail "Git: Not installed"
    echo "         Install from: https://git-scm.com/downloads"
fi

# Check: Git configured (user.name and user.email)
if command -v git &> /dev/null; then
    GIT_NAME=$(git config user.name 2>/dev/null || echo "")
    GIT_EMAIL=$(git config user.email 2>/dev/null || echo "")

    if [[ -n "$GIT_NAME" && -n "$GIT_EMAIL" ]]; then
        check_pass "Git identity: $GIT_NAME <$GIT_EMAIL>"
    else
        check_fail "Git identity: Not configured"
        echo "         Run: git config --global user.name \"Your Name\""
        echo "              git config --global user.email \"you@example.com\""
    fi
fi

# Check: GitHub connectivity
GITHUB_OK=false

# Try gh CLI first (most reliable if installed)
if command -v gh &> /dev/null; then
    # gh auth status returns 0 if logged in, non-zero if not
    if gh auth status &> /dev/null; then
        GH_USER=$(gh api user --jq .login 2>/dev/null || echo "authenticated")
        check_pass "GitHub: Authenticated as $GH_USER (via gh CLI)"
        GITHUB_OK=true
    fi
fi

# If gh didn't work, try SSH (with timeout)
if [[ "$GITHUB_OK" == "false" ]] && command -v ssh &> /dev/null; then
    SSH_RESULT=$(ssh -o BatchMode=yes -o ConnectTimeout=3 -o StrictHostKeyChecking=accept-new -T git@github.com 2>&1 || true)
    if echo "$SSH_RESULT" | grep -q "successfully authenticated"; then
        check_pass "GitHub: SSH authentication working"
        GITHUB_OK=true
    fi
fi

# Last resort: just check HTTPS reachability
if [[ "$GITHUB_OK" == "false" ]]; then
    if curl -s --max-time 3 --head https://github.com 2>/dev/null | head -n1 | grep -q "200"; then
        check_warn "GitHub: Reachable (SSH/gh not configured)"
        echo "         gh CLI: brew install gh && gh auth login"
    else
        check_fail "GitHub: Cannot reach github.com"
    fi
fi

# ============================================================================
# SHOULD HAVE (For Core Features)
# ============================================================================

section "Should Have (Core Features)"

# Check: Python 3.9+
if command -v python3 &> /dev/null; then
    PYTHON_VERSION=$(python3 --version 2>&1 | awk '{print $2}')
    PYTHON_MAJOR=$(echo "$PYTHON_VERSION" | cut -d. -f1)
    PYTHON_MINOR=$(echo "$PYTHON_VERSION" | cut -d. -f2)

    if [[ "$PYTHON_MAJOR" -ge 3 && "$PYTHON_MINOR" -ge 9 ]]; then
        check_pass "Python: $PYTHON_VERSION"
    else
        check_warn "Python: $PYTHON_VERSION (3.9+ recommended)"
        echo "         Some features may not work correctly"
    fi
else
    check_warn "Python: Not found"
    echo "         Install from: https://www.python.org/downloads/"
    echo "         Or: brew install python"
fi

# Check: uvx or pipx (for Serena)
if command -v uvx &> /dev/null; then
    UVX_VERSION=$(uvx --version 2>/dev/null | head -n1 || echo "installed")
    check_pass "uvx: $UVX_VERSION"
elif command -v pipx &> /dev/null; then
    PIPX_VERSION=$(pipx --version 2>/dev/null || echo "installed")
    check_pass "pipx: $PIPX_VERSION"
else
    check_warn "uvx/pipx: Neither found (needed for Serena)"
    echo "         Install uvx: curl -LsSf https://astral.sh/uv/install.sh | sh"
    echo "         Or pipx:     brew install pipx && pipx ensurepath"
fi

# ============================================================================
# NICE TO HAVE (Optional Enhancements)
# ============================================================================

section "Nice to Have (Optional)"

# Check: OpenAI API Key
if [[ -n "${OPENAI_API_KEY:-}" ]]; then
    # Mask the key for display
    MASKED_KEY="${OPENAI_API_KEY:0:7}...${OPENAI_API_KEY: -4}"
    check_pass "OpenAI API Key: $MASKED_KEY (set in environment)"
elif [[ -f ".env" ]] && grep -q "OPENAI_API_KEY=" .env 2>/dev/null; then
    check_pass "OpenAI API Key: Found in .env"
else
    check_warn "OpenAI API Key: Not configured"
    echo "         Needed for: Adversarial evaluation (~\$0.04/eval)"
    echo "         Get key at: https://platform.openai.com/api-keys"
fi

# Check: Linear API Key
if [[ -n "${LINEAR_API_KEY:-}" ]]; then
    check_pass "Linear API Key: Set in environment"
elif [[ -f ".env" ]] && grep -q "LINEAR_API_KEY=" .env 2>/dev/null; then
    check_pass "Linear API Key: Found in .env"
else
    check_warn "Linear API Key: Not configured"
    echo "         Needed for: Task sync with Linear"
    echo "         Get key at: https://linear.app/{workspace}/settings/account/security"
fi

# Check: pre-commit (for TDD hooks)
if command -v pre-commit &> /dev/null; then
    PC_VERSION=$(pre-commit --version 2>/dev/null || echo "installed")
    check_pass "pre-commit: $PC_VERSION"
else
    check_warn "pre-commit: Not installed"
    echo "         Needed for: TDD pre-commit hooks"
    echo "         Install: pip install pre-commit"
fi

# Check: adversarial (for evaluation workflow)
if command -v adversarial &> /dev/null; then
    ADV_VERSION=$(adversarial --version 2>/dev/null || echo "installed")
    check_pass "adversarial: $ADV_VERSION"
else
    check_warn "adversarial: Not installed"
    echo "         Needed for: GPT-4o task evaluation"
    echo "         Install: pip install -e \".[dev]\""
fi

# ============================================================================
# SUMMARY
# ============================================================================

echo ""
echo -e "${BOLD}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BOLD}                         Summary                               ${NC}"
echo -e "${BOLD}═══════════════════════════════════════════════════════════════${NC}"
echo ""
echo -e "  ${GREEN}✓ Passed:${NC}   $PASS"
echo -e "  ${YELLOW}⚠ Warnings:${NC} $WARN"
echo -e "  ${RED}✗ Failed:${NC}   $FAIL"
echo ""

if [[ $FAIL -gt 0 ]]; then
    echo -e "${RED}${BOLD}Some required checks failed.${NC}"
    echo "Please resolve the issues above before running onboarding."
    echo ""
    exit 1
elif [[ $WARN -gt 0 ]]; then
    echo -e "${YELLOW}${BOLD}Ready to proceed with warnings.${NC}"
    echo "Optional features may be limited. You can set these up later."
    echo ""
    echo "Next step: ./agents/onboarding"
    echo ""
    exit 0
else
    echo -e "${GREEN}${BOLD}All checks passed! You're ready to go.${NC}"
    echo ""
    echo "Next step: ./agents/onboarding"
    echo ""
    exit 0
fi
