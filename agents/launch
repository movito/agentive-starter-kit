#!/bin/bash

# Agentive Starter Kit - Agent Launcher v1.0.0
# Reads Claude Code native agent definitions from .claude/agents/

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
CLAUDE_AGENTS_DIR="$PROJECT_ROOT/.claude/agents"
CONTEXT_DIR="$PROJECT_ROOT/.agent-context"
PROJECT_NAME=$(basename "$PROJECT_ROOT")

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Check for Claude agents directory
if [[ ! -d "$CLAUDE_AGENTS_DIR" ]]; then
    echo -e "${RED}Error: Claude agents directory not found: $CLAUDE_AGENTS_DIR${NC}"
    exit 1
fi

# Parse YAML frontmatter from markdown file
parse_frontmatter() {
    local file="$1"
    local key="$2"

    # Extract frontmatter between --- markers
    local frontmatter=$(sed -n '/^---$/,/^---$/p' "$file" | sed '1d;$d')

    # Get value for key
    echo "$frontmatter" | grep "^$key:" | sed "s/^$key:[[:space:]]*//" | tr -d '"'
}

# Get list of available agent files with custom ordering
get_agent_files() {
    # =========================================================================
    # AGENT DISPLAY ORDER
    # Edit this array to change the order agents appear in the menu.
    # Agents not listed here will appear at the end alphabetically.
    # =========================================================================
    local agent_order=(
        "planner"
        "feature-developer"
        "test-runner"
        "tycho"
        "powertest-runner"
        "document-reviewer"
        "security-reviewer"
        "ci-checker"
        "agent-creator"
    )

    # Get all agent files (excluding templates and operational files)
    local all_files=$(find "$CLAUDE_AGENTS_DIR" -name "*.md" \
        -not -name "OPERATIONAL-RULES.md" \
        -not -name "AGENT-TEMPLATE.md")

    # Output files in custom order
    for agent_name in "${agent_order[@]}"; do
        for file in $all_files; do
            local base_name=$(basename "$file" .md)
            if [[ "$base_name" == "$agent_name" ]]; then
                echo "$file"
                break
            fi
        done
    done

    # Add any remaining files not in the custom order (for future agents)
    for file in $all_files; do
        local base_name=$(basename "$file" .md)
        local found=0
        for agent_name in "${agent_order[@]}"; do
            if [[ "$base_name" == "$agent_name" ]]; then
                found=1
                break
            fi
        done
        if [[ $found -eq 0 ]]; then
            echo "$file"
        fi
    done
}

# Get agent metadata from markdown file
get_agent_name() {
    local file="$1"
    parse_frontmatter "$file" "name"
}

get_agent_description() {
    local file="$1"
    parse_frontmatter "$file" "description"
}

get_agent_model() {
    local file="$1"
    local model=$(parse_frontmatter "$file" "model")
    # Default to Sonnet 4.5 if not specified
    echo "${model:-claude-sonnet-4-5-20250929}"
}

# Display header
display_header() {
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}   Agentive Starter Kit v1.0.0        ${NC}"
    echo -e "${BLUE}   Agent Launcher                     ${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo
}

# Display available agents
list_agents() {
    local agent_files=($(get_agent_files))

    echo -e "${GREEN}Available Agents:${NC}"
    echo

    local counter=1
    for agent_file in "${agent_files[@]}"; do
        local name=$(get_agent_name "$agent_file")
        local description=$(get_agent_description "$agent_file")
        local icon=$(get_agent_icon "$name")

        echo -e "  ${YELLOW}$counter${NC}) $icon $name - $description"
        counter=$((counter + 1))
    done
    echo
    echo -e "  ${BLUE}Tip:${NC} To reorder or customize agents, edit ${YELLOW}agents/launch${NC}"
    echo
}

# Check if Serena MCP is configured in Claude Code
is_serena_configured() {
    # Check if claude mcp list shows serena
    if command -v claude &> /dev/null; then
        if claude mcp list 2>/dev/null | grep -q "serena"; then
            return 0  # true - Serena is configured
        fi
    fi
    return 1  # false - Serena not configured
}

# Check if agent needs Serena auto-activation
needs_serena_activation() {
    local name="$1"

    # First check if Serena is even configured
    if ! is_serena_configured; then
        return 1  # false - Serena not available
    fi

    # =========================================================================
    # SERENA-ENABLED AGENTS
    # These agents get automatic Serena activation for semantic code navigation.
    # Add agent names here if they work with code and would benefit from Serena.
    # =========================================================================
    local serena_agents=(
        "planner"
        "feature-developer"
        "test-runner"
        "tycho"
        "powertest-runner"
        "security-reviewer"
    )

    for serena_agent in "${serena_agents[@]}"; do
        if [[ "$name" == "$serena_agent" ]]; then
            return 0  # true - needs activation
        fi
    done

    return 1  # false - doesn't need activation
}

# Launch specific agent
launch_agent() {
    local agent_index="$1"
    local agent_files=($(get_agent_files))

    if [[ $agent_index -lt 1 || $agent_index -gt ${#agent_files[@]} ]]; then
        echo -e "${RED}Invalid selection: $agent_index${NC}"
        return 1
    fi

    local agent_file="${agent_files[$((agent_index - 1))]}"
    local name=$(get_agent_name "$agent_file")
    local model=$(get_agent_model "$agent_file")

    # Read full markdown content (including frontmatter and documentation)
    local full_agent_content=$(cat "$agent_file")

    echo -e "${GREEN}Launching agent: ${YELLOW}$name${NC}"
    echo -e "${BLUE}Model: ${NC}$model"

    # Check Serena status for code-focused agents
    local is_code_agent=false
    for sa in "${serena_agents[@]}"; do
        [[ "$name" == "$sa" ]] && is_code_agent=true && break
    done

    if [[ "$is_code_agent" == true ]]; then
        if is_serena_configured; then
            echo -e "${BLUE}Serena: ${GREEN}configured${NC} (semantic navigation enabled)"
        else
            echo -e "${BLUE}Serena: ${YELLOW}not configured${NC} (run .serena/setup-serena.sh to enable)"
        fi
    fi
    echo

    # Change to project directory
    cd "$PROJECT_ROOT"

    # Launch Claude with model and full agent markdown as system prompt
    # For code-focused agents, send initial Serena activation prompt
    if needs_serena_activation "$name"; then
        exec claude --model "$model" --append-system-prompt "$full_agent_content" \
            "Please activate Serena for semantic code navigation in this project before we begin. Use: mcp__serena__activate_project(\"$PROJECT_NAME\")"
    else
        exec claude --model "$model" --append-system-prompt "$full_agent_content"
    fi
}

# Get icon for agent name
get_agent_icon() {
    local name="$1"
    local icon="‚ö°"
    [[ "$name" == *"planner"* ]] && icon="üìã"
    [[ "$name" == *"tycho"* ]] && icon="üß≠"
    [[ "$name" == *"feature"* ]] && icon="üõ†Ô∏è"
    [[ "$name" == *"test"* ]] && icon="üß™"
    [[ "$name" == *"document"* ]] && icon="üìÑ"
    [[ "$name" == *"security"* ]] && icon="üîí"
    [[ "$name" == *"ci-checker"* ]] && icon="‚úÖ"
    [[ "$name" == *"agent-creator"* ]] && icon="ü§ñ"
    echo "$icon"
}

# Interactive agent selection
interactive_select() {
    local agent_files=($(get_agent_files))

    # Build menu options
    local options=()
    for agent_file in "${agent_files[@]}"; do
        local name=$(get_agent_name "$agent_file")
        local icon=$(get_agent_icon "$name")
        options+=("$icon $name")
    done

    echo -e "${GREEN}Select an agent:${NC}"
    echo

    # Force single column display
    COLUMNS=1
    PS3="Choose (number or type name): "
    select opt in "${options[@]}"; do
        if [[ -n "$opt" ]]; then
            # Get the selected index
            local selected_index=$REPLY
            launch_agent "$selected_index"
            break
        elif [[ -n "$REPLY" ]]; then
            # Try to match by name
            local match_found=false
            local counter=1
            for agent_file in "${agent_files[@]}"; do
                local name=$(get_agent_name "$agent_file")
                local name_lower=$(echo "$name" | tr '[:upper:]' '[:lower:]')
                local reply_lower=$(echo "$REPLY" | tr '[:upper:]' '[:lower:]')

                # Match partial names (e.g., "feat" matches "feature-developer")
                if [[ "$name_lower" == *"$reply_lower"* ]]; then
                    launch_agent "$counter"
                    match_found=true
                    break
                fi
                counter=$((counter + 1))
            done

            if [[ "$match_found" == false ]]; then
                echo -e "${RED}No agent found matching '$REPLY'. Try again:${NC}"
            fi
        else
            echo -e "${YELLOW}Please select a number or type an agent name.${NC}"
        fi
    done
}

# Main execution
main() {
    display_header

    if [[ $# -eq 0 ]]; then
        interactive_select
        exit 0
    fi

    case "$1" in
        help)
            list_agents
            echo -e "${BLUE}Usage:${NC}"
            echo "  $0                   Interactive selection"
            echo "  $0 <agent-name>      Launch agent by name"
            echo "  $0 <agent-number>    Launch specific agent"
            echo "  $0 help             Show this help"
            ;;
        [1-9])
            launch_agent "$1"
            ;;
        *)
            # Try to match by name
            local agent_files=($(get_agent_files))
            local match_found=false
            local counter=1

            for agent_file in "${agent_files[@]}"; do
                local name=$(get_agent_name "$agent_file")
                local name_lower=$(echo "$name" | tr '[:upper:]' '[:lower:]')
                local arg_lower=$(echo "$1" | tr '[:upper:]' '[:lower:]')

                # Match partial names
                if [[ "$name_lower" == *"$arg_lower"* ]]; then
                    launch_agent "$counter"
                    match_found=true
                    break
                fi
                counter=$((counter + 1))
            done

            if [[ "$match_found" == false ]]; then
                echo -e "${RED}Error: No agent found matching '$1'${NC}"
                echo -e "${YELLOW}Available agents:${NC}"
                list_agents
                exit 1
            fi
            ;;
    esac
}

# Check for project context directory
if [[ ! -d "$CONTEXT_DIR" ]]; then
    echo -e "${YELLOW}Warning: No .agent-context/ directory found${NC}"
    echo "Agents will launch without project context"
    echo
fi

main "$@"
