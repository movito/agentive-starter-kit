#!/bin/bash

# Agentive Starter Kit - First-Run Onboarding
# Launches planner with full context for new project setup

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
CLAUDE_AGENTS_DIR="$PROJECT_ROOT/.claude/agents"
PROJECT_NAME=$(basename "$PROJECT_ROOT")

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Display welcome banner
echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}â•‘                                                                â•‘${NC}"
echo -e "${CYAN}â•‘   ${GREEN}ðŸš€ Agentive Starter Kit - First-Run Onboarding${CYAN}              â•‘${NC}"
echo -e "${CYAN}â•‘                                                                â•‘${NC}"
echo -e "${CYAN}â•‘   ${NC}Welcome! This will configure your new agentive project.${CYAN}      â•‘${NC}"
echo -e "${CYAN}â•‘   ${NC}planner (your planning agent) will guide you through setup.${CYAN}   â•‘${NC}"
echo -e "${CYAN}â•‘                                                                â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

# Run preflight check
PREFLIGHT_SCRIPT="$SCRIPT_DIR/preflight"
if [[ -x "$PREFLIGHT_SCRIPT" ]]; then
    echo -e "${BLUE}Running preflight checks...${NC}"
    echo
    
    # Run preflight and capture exit code
    "$PREFLIGHT_SCRIPT"
    PREFLIGHT_EXIT=$?
    
    if [[ $PREFLIGHT_EXIT -eq 1 ]]; then
        echo
        echo -e "${RED}Please resolve the issues above before continuing.${NC}"
        echo -e "Run ${CYAN}./agents/preflight${NC} again after fixing."
        exit 1
    elif [[ $PREFLIGHT_EXIT -eq 0 ]]; then
        # Check if there were warnings (the script prints a specific message)
        echo
        read -p "Continue with onboarding? (Y/n): " confirm
        if [[ "$confirm" =~ ^[Nn]$ ]]; then
            echo -e "${BLUE}Run ./agents/onboarding again when ready.${NC}"
            exit 0
        fi
    fi
    echo
else
    echo -e "${YELLOW}Warning: preflight script not found. Skipping checks.${NC}"
    echo
fi

# Check if already configured
if [[ -f "$PROJECT_ROOT/.env" ]]; then
    echo -e "${YELLOW}Note: .env file already exists.${NC}"
    echo -e "If you want to re-run onboarding, remove .env first:"
    echo -e "  rm .env"
    echo
    read -p "Continue anyway? (y/N): " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo -e "${BLUE}Use ./agents/launch for regular agent access.${NC}"
        exit 0
    fi
fi

# Check for onboarding agent
ONBOARDING_AGENT="$CLAUDE_AGENTS_DIR/onboarding.md"
if [[ ! -f "$ONBOARDING_AGENT" ]]; then
    echo -e "${RED}Error: onboarding agent not found at $ONBOARDING_AGENT${NC}"
    exit 1
fi

# Read onboarding agent content
ONBOARDING_CONTENT=$(cat "$ONBOARDING_AGENT")

# Get model from onboarding.md frontmatter
ONBOARDING_MODEL=$(sed -n '/^---$/,/^---$/p' "$ONBOARDING_AGENT" | sed '1d;$d' | grep "^model:" | sed "s/^model:[[:space:]]*//" | tr -d '"')
ONBOARDING_MODEL="${ONBOARDING_MODEL:-claude-sonnet-4-20250514}"

# Create onboarding state file
ONBOARDING_STATE="$PROJECT_ROOT/.agent-context/ONBOARDING-STATE.md"
cat > "$ONBOARDING_STATE" << 'EOF'
# Onboarding State

**Status**: In Progress
**Started**: $(date +%Y-%m-%d)

## Checklist

- [ ] Phase 1: Project name configured
- [ ] Phase 2: Languages selected
- [ ] Phase 3: API keys configured
- [ ] Phase 4: Features selected
- [ ] Phase 5: Agents customized
- [ ] Phase 6: Configuration files created
- [ ] Phase 7: GitHub repository setup

## Configuration

- Project Name: (pending)
- Languages: (pending)
- Task Prefix: (pending)
- Linear Integration: (pending)
- Serena MCP: (pending)

---
*This file tracks onboarding progress. Delete after completion.*
EOF

# Replace the date placeholder
sed -i '' "s/\$(date +%Y-%m-%d)/$(date +%Y-%m-%d)/" "$ONBOARDING_STATE" 2>/dev/null || \
    sed -i "s/\$(date +%Y-%m-%d)/$(date +%Y-%m-%d)/" "$ONBOARDING_STATE"

echo -e "${GREEN}Project:${NC} $PROJECT_NAME"
echo -e "${GREEN}Agent:${NC} onboarding (setup specialist)"
echo -e "${GREEN}Model:${NC} $ONBOARDING_MODEL"
echo

# Build first-run context
FIRST_RUN_CONTEXT="
**FIRST-RUN ONBOARDING ACTIVE**

Project Context:
- Folder name: $PROJECT_NAME (suggest this as project name)
- Location: $PROJECT_ROOT
- Status: No .env file (unconfigured)
- Onboarding state: $ONBOARDING_STATE

Begin Phase 1 immediately. Suggest '$PROJECT_NAME' as the project name since that's the folder name.
"

echo -e "${BLUE}Launching onboarding agent...${NC}"
echo

# Change to project directory
cd "$PROJECT_ROOT"

# Launch Claude with onboarding agent + first-run context
exec claude --model "$ONBOARDING_MODEL" --append-system-prompt "$ONBOARDING_CONTENT" "$FIRST_RUN_CONTEXT"
